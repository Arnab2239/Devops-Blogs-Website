const express = require('express');
const cors = require('cors');
const morgan = require('morgan');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 5000;

// Sample blog posts data
const blogPosts = [
  {
    id: 1,
    title: "Getting Started with Docker",
    excerpt: "Learn the basics of containerization",
    content: "Docker revolutionizes how we deploy applications...",
    author: "Admin",
    date: "2024-01-15",
    readTime: "5 min"
  },
  {
    id: 2,
    title: "Building Microservices with Node.js",
    excerpt: "A practical guide to microservices architecture",
    content: "Microservices offer scalability and flexibility...",
    author: "Admin",
    date: "2024-01-20",
    readTime: "8 min"
  },
  {
    id: 3,
    title: "Next.js Best Practices",
    excerpt: "Tips for building modern web applications",
    content: "Next.js combines the best of React with server-side rendering...",
    author: "Admin",
    date: "2024-01-25",
    readTime: "6 min"
  }
];

// Middleware
app.use(cors());
app.use(morgan('combined'));
app.use(express.json());

// API Routes

// Get all posts
app.get('/api', (req, res) => {
  res.status(200).json({ 
    status: 'OK', 
    message: 'Blog API is online',
    posts: blogPosts.length
  });
});

// Get all blog posts
app.get('/api/posts', (req, res) => {
  res.json(blogPosts.map(post => ({
    id: post.id,
    title: post.title,
    excerpt: post.excerpt,
    author: post.author,
    date: post.date,
    readTime: post.readTime
  })));
});

// Get single blog post
app.get('/api/posts/:id', (req, res) => {
  const post = blogPosts.find(p => p.id === parseInt(req.params.id));
  if (post) {
    res.json(post);
  } else {
    res.status(404).json({ error: 'Post not found' });
  }
});

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    service: 'blog-backend-api',
    timestamp: new Date().toISOString()
  });
});

// Welcome endpoint
app.get('/', (req, res) => {
  res.json({ 
    message: 'Welcome to Blog Backend API',
    version: '1.0.0',
    endpoints: {
      posts: '/api/posts',
      health: '/health'
    }
  });
});

// Error handling middleware
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ error: 'Something went wrong!' });
});

app.listen(PORT, '0.0.0.0', () => {
  console.log(`Blog Backend API running on port ${PORT}`);
});